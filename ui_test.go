package ui

import (
  "flag"
  "testing"
  "github.com/stretchr/testify/assert"
  
  "github.com/google/uuid"
)

func TestCheckUI(t *testing.T) {
  Init("./etc.test/", false, false)
  
  ui_json_need := "{\"forms\":{\"request_test\":{\"code\":\"request_test\",\"enctype\":\"multipart/form-data\",\"method\":\"POST\",\"action\":\"\",\"version\":1,\"date\":\"2019/10/1\",\"date_start\":\"2019/10/1\",\"date_finish\":\"2300/1/15\",\"title\":\"Заявление на выдачу\",\"type\":\"\",\"description\":\"Выдержка из административного регламента:\",\"tabs\":[{\"code\":\"applicant\",\"order\":10,\"title\":\"Заявитель\",\"description\":\"\",\"fields\":[\"applicant.type\",\"applicant.tel\",\"applicant.inn\",\"applicant.ogrn\"]},{\"code\":\"owner\",\"order\":20,\"title\":\"Правообладатель\",\"description\":\"\",\"fields\":[\"owner.type\",\"owner.inn\",\"owner.ogrn\"]},{\"code\":\"land_plot\",\"order\":30,\"title\":\"Участок\",\"description\":\"\",\"fields\":[\"municipality\",\"zu.kn\",\"zu.right\"]},{\"code\":\"project\",\"order\":40,\"title\":\"Проект\",\"description\":\"\",\"fields\":null},{\"code\":\"docs\",\"order\":50,\"title\":\"Документы\",\"description\":\"\",\"fields\":[\"docs.egrn\",\"docs.egrip\",\"docs.kp\"]},{\"code\":\"result\",\"order\":60,\"title\":\"Регистрация\",\"description\":\"\",\"fields\":[\"result.delivery\",\"result.email\",\"result.comments\"]}],\"properties\":[{\"code\":\"municipality\",\"order\":10,\"title\":\"Муниципалитет\",\"description\":\"\",\"data_type\":\"\",\"widget\":\"select-mdm\",\"required\":\"true\",\"format\":\"\",\"table\":\"municipality\",\"default\":\"\",\"oneOf\":null,\"oneOfConst\":\"\"},{\"code\":\"docs.egrip\",\"order\":20,\"title\":\"Выписка из ЕГРИП\",\"description\":\"\",\"data_type\":\"\",\"widget\":\"file\",\"required\":\"\",\"format\":\"\",\"table\":\"\",\"default\":\"\",\"oneOf\":null,\"oneOfConst\":\"\"},{\"code\":\"docs.kp\",\"order\":30,\"title\":\"Кадастровый паспорт\",\"description\":\"\",\"data_type\":\"\",\"widget\":\"file\",\"required\":\"\",\"format\":\"\",\"table\":\"\",\"default\":\"\",\"oneOf\":null,\"oneOfConst\":\"\"}],\"buttons\":[{\"code\":\"submit\",\"order\":0,\"title\":\"Сохранить\",\"type\":\"\"},{\"code\":\"close\",\"order\":0,\"title\":\"Закрыть\",\"type\":\"\"}]}},\"views\":{}}"
  ui_json := string(ToJSON("admin", "ru", []string{"monitoring.main"}, []string{"request_test"}, []string{"test"}))
  
  assert.Equal(t, ui_json_need, ui_json)
}

func TestCheckUIRender(t *testing.T) {
	flag.Set("alsologtostderr", "true")
	flag.Set("log_dir", ".")
	flag.Set("v", "9")
	flag.Parse()

  Init("./etc.test/", false, false)
  render_form1_need := "<div class=\"modal fade\" id=\"request_test\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\">\n<form method=\"POST\" action=\"\" enctype=\"multipart/form-data\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Заявление на выдачу</h5>\n        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\">\n          <span aria-hidden=\"true\">&times;</span>\n        </button>\n      </div>\n      <div class=\"modal-body\">\n<ul class=\"stepper horizontal\" id=\"horizontal-stepper-request_test\">\n\n</ui>\n      </div>\n      <div class=\"modal-footer\">\n<span>ERR: templateFile(bootstrap4:request_test): not found button 'submit'</span><span>ERR: templateFile(bootstrap4:request_test): not found button 'close'</span>\n      </div>\n    </div>\n  </div>\n</form>\n</div>\n"
  // Modal Form for New Record
  render_form1 := RenderForm("ru_RU", "request_test", "bootstrap4", true, nil)

  assert.Equal(t, render_form1_need, render_form1)

  uid4, _ := uuid.Parse("00000002-0003-0004-0005-000000000004")
  services := []map[string]interface{}{{"User_JWT": "111", "Name": "Service 1"}, {"User_JWT": "112", "Name": "Service 2"}, {"User_JWT": "131", "Name": "Service 3"}}
  data := map[string]interface{}{"id": uid4, "User_DisplayName": "Sergey Lunkov", "Services": services}

  render1_need := "\n<!doctype html>\n<html lang=\"ru\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/static/css/style.css\">\n    <title>#Home#</title>\n  </head>\n  Hello, Sergey Lunkov!\n\n  <body>\n\tERR: FORM(welcome.1) NOT FOUND \n    <nav class=\"navbar navbar-dark bg-dark\">\n      <span class=\"navbar-brand mb-0 h1\"></span>\n      <ul class=\"navbar-nav mr-auto\">\n        <li class=\"nav-item active\">\n          <a class=\"nav-link\" href=\"/\">Services</a>\n        </li>\n      </ul>\n      <li class=\"nav-item dropdown\">\n\t\t\t  <a class=\"nav-link dropdown-toggle row\" href=\"#\" role=\"button\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\n\t\t\t\t<div class=\"column\">Sergey Lunkov</div><div class=\"column\"><img src=\"\" class=\"avatar\"></div>\n\t\t\t  </a>\n        <div class=\"dropdown-menu\" aria-labelledby=\"navbarDropdown\">\n          <a class=\"dropdown-item\" href=\"/profile\">My profile</a>\n          <div class=\"dropdown-divider\"></div>\n          <a class=\"dropdown-item\" href=\"/logout\">Exit</a>\n        </div>\n       </li>\n    </nav>\n<br>\n<div class=\"container\">\n\nLanguage: en_US\n[[ .User_DisplayName ]]\n\n<ul id=\"hexGrid\">\n\n      <li class=\"hex\">\n        <div class=\"hexIn\">\n          <a class=\"hexLink\" href=\"/?k=111\" target=\"_blank\">\n            <img src=\"\" alt=\"\">\n            <h1>Service 1</h1>\n            <p></p>\n          </a>\n        </div>\n      </li>\n\n      <li class=\"hex\">\n        <div class=\"hexIn\">\n          <a class=\"hexLink\" href=\"/?k=112\" target=\"_blank\">\n            <img src=\"\" alt=\"\">\n            <h1>Service 2</h1>\n            <p></p>\n          </a>\n        </div>\n      </li>\n\n      <li class=\"hex\">\n        <div class=\"hexIn\">\n          <a class=\"hexLink\" href=\"/?k=131\" target=\"_blank\">\n            <img src=\"\" alt=\"\">\n            <h1>Service 3</h1>\n            <p></p>\n          </a>\n        </div>\n      </li>\n\n</ul>\n\n<div class=\"modal fade\" id=\"news\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\">\n<form method=\"POST\" action=\"/api/news_public\" enctype=\"multipart/form-data\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Редактирование новости</h5>\n        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\">\n          <span aria-hidden=\"true\">&times;</span>\n        </button>\n      </div>\n      <div class=\"modal-body\">\n<div class=\"form-group\">\n    <input type=\"hidden\" class=\"form-control\" id=\"id\" name=\"id\" value=\"\">\n</div>\n<div class=\"form-group\">\n    <label for=\"title\">Заголовок</label>\n    <input type=\"text\" class=\"form-control\" id=\"title\" placeholder=\"\" value=\"\">\n</div>\n<div class=\"form-group\">\n    <label for=\"public_date\">Дата публикации</label>\n    <input type=\"text\" class=\"form-control\" id=\"public_date\" name=\"public_date\" placeholder=\"\" value=\"\">\n</div>\n<div class=\"form-group\">\n    <label for=\"description\">Описание</label>\n    <textarea id=\"description\" name=\"description\"></textarea>\n<script>\n$(\"#description\").sceditor({\n\t  plugins: \"xhtml\",\n\t  toolbar: \"bold,italic,underline,strike,subscript,superscript|left,center,right,justify|size,color,removeformat|cut,copy,pastetext|bulletlist,orderedlist,indent,outdent|table|code,quote|horizontalrule,image,email,link,unlink|youtube,time|ltr,rtl|print,maximize,source\",\n\t  charset: \"utf-8\",\n\t  style: '/static/css/sceditor/themes/default.min.css',\n\t  emoticonsEnabled: false,\n\t  resizeEnabled: false,\n\t  height:600,\n\t  spellcheck: true,\n\t});\n</script>\n</div>\n<div class=\"form-group\">\n    <label for=\"images\">Файлы</label>\n    <input type=\"file\" class=\"form-control\" id=\"images\" name=\"images[]\"  data-show-upload=\"false\" data-show-caption=\"true\" multiple placeholder=\"\">\n</div>\n\n      </div>\n      <div class=\"modal-footer\">\n<button id=\"news-SUBMIT-BUTTON\" type=\"button\" class=\"btn btn-primary\">\n  <span>Save</span>\n</button>\n<button type=\"button\" class=\"btn btn-secondary\" data-dismiss=\"modal\">Close</button>\n      </div>\n    </div>\n  </div>\n</form>\n</div>\n\n<div class=\"row\">\n\t<div class=\"col-lg-10\">\n    \n\t\t<table\n\t\t  id=\"table-table_edit_news\"\n\t\t  data-toolbar=\"#toolbar-table_edit_news\"\n\t\t  data-toggle=\"table\"\n\n\t\t  data-id-field=\"id\"\n\t\t  data-click-to-select=\"true\"\n\t\t  data-url=\"\"\n\t\t  data-response-handler=\"responseTableHandler\">\n\t\t</table>\n\n\t</div>\n</div>\n\n<script>\n\t\nclass tableEdit {\n  constructor() {\n    this.edit_form = \"news\";\n    this.view_url = \"\\/page\\/1news\\/ru_RU?item=\";\n    this.read_item_url = \"\";\n    this.write_item_url = \"\";\n    this.table = $('#table-table_edit_news');\n  }\n  \n  $this.table.bootstrapTable('destroy').bootstrapTable({\n      locale: \"en_US\", \n      columns: [\n      \n        {\n          field: 'id',\n          title: 'ID',\n          sortable:  false ,\n          align: 'center'\n        },\n      \n        {\n          field: 'title',\n          title: 'Title',\n          sortable:  true ,\n          align: 'left'\n        },\n      \n        {\n          field: 'public_at',\n          title: 'Public At',\n          sortable:  true ,\n          align: 'center'\n        },\n      \n        {\n          field: 'operate',\n          title: 'Действия',\n          align: 'left',\n          clickToSelect: false,\n          events: window.operateEvents,\n          formatter: operateFormatter\n        }]\n    })\n}\n</script>\n\n\n\nBye, Sergey Lunkov!\n\n\n</div>\n    <script src=\"https://code.jquery.com/jquery-3.3.1.slim.min.js\" integrity=\"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo\" crossorigin=\"anonymous\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js\" integrity=\"sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49\" crossorigin=\"anonymous\"></script>\n    <script src=\"https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js\" integrity=\"sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy\" crossorigin=\"anonymous\"></script>\n  </body>\n</html>\n"
  render1, okr := renderPage("en_US", "index", "bootstrap4", false, &data)
  assert.Equal(t, true, okr)
  assert.Equal(t, render1_need, render1)

  render1_need = "\n<!doctype html>\n<html lang=\"ru\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"/static/css/style.css\">\n    <title>#Home#</title>\n  </head>\n  Hello, Sergey Lunkov!\n\n  <body>\n\tERR: FORM(welcome.1) NOT FOUND \n    <nav class=\"navbar navbar-dark bg-dark\">\n      <span class=\"navbar-brand mb-0 h1\"></span>\n      <ul class=\"navbar-nav mr-auto\">\n        <li class=\"nav-item active\">\n          <a class=\"nav-link\" href=\"/\">Services</a>\n        </li>\n      </ul>\n      <li class=\"nav-item dropdown\">\n\t\t\t  <a class=\"nav-link dropdown-toggle row\" href=\"#\" role=\"button\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\n\t\t\t\t<div class=\"column\">Sergey Lunkov</div><div class=\"column\"><img src=\"\" class=\"avatar\"></div>\n\t\t\t  </a>\n        <div class=\"dropdown-menu\" aria-labelledby=\"navbarDropdown\">\n          <a class=\"dropdown-item\" href=\"/profile\">My profile</a>\n          <div class=\"dropdown-divider\"></div>\n          <a class=\"dropdown-item\" href=\"/logout\">Exit</a>\n        </div>\n       </li>\n    </nav>\n<br>\n<div class=\"container\">\n\nLanguage: en_US\nSergey Lunkov\n\n<ul id=\"hexGrid\">\n\n      <li class=\"hex\">\n        <div class=\"hexIn\">\n          <a class=\"hexLink\" href=\"/?k=111\" target=\"_blank\">\n            <img src=\"\" alt=\"\">\n            <h1>Service 1</h1>\n            <p></p>\n          </a>\n        </div>\n      </li>\n\n      <li class=\"hex\">\n        <div class=\"hexIn\">\n          <a class=\"hexLink\" href=\"/?k=112\" target=\"_blank\">\n            <img src=\"\" alt=\"\">\n            <h1>Service 2</h1>\n            <p></p>\n          </a>\n        </div>\n      </li>\n\n      <li class=\"hex\">\n        <div class=\"hexIn\">\n          <a class=\"hexLink\" href=\"/?k=131\" target=\"_blank\">\n            <img src=\"\" alt=\"\">\n            <h1>Service 3</h1>\n            <p></p>\n          </a>\n        </div>\n      </li>\n\n</ul>\n\n<div class=\"modal fade\" id=\"news\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\">\n<form method=\"POST\" action=\"/api/news_public\" enctype=\"multipart/form-data\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Редактирование новости</h5>\n        <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\">\n          <span aria-hidden=\"true\">&times;</span>\n        </button>\n      </div>\n      <div class=\"modal-body\">\n<div class=\"form-group\">\n    <input type=\"hidden\" class=\"form-control\" id=\"id\" name=\"id\" value=\"\">\n</div>\n<div class=\"form-group\">\n    <label for=\"title\">Заголовок</label>\n    <input type=\"text\" class=\"form-control\" id=\"title\" placeholder=\"\" value=\"\">\n</div>\n<div class=\"form-group\">\n    <label for=\"public_date\">Дата публикации</label>\n    <input type=\"text\" class=\"form-control\" id=\"public_date\" name=\"public_date\" placeholder=\"\" value=\"\">\n</div>\n<div class=\"form-group\">\n    <label for=\"description\">Описание</label>\n    <textarea id=\"description\" name=\"description\"></textarea>\n<script>\n$(\"#description\").sceditor({\n\t  plugins: \"xhtml\",\n\t  toolbar: \"bold,italic,underline,strike,subscript,superscript|left,center,right,justify|size,color,removeformat|cut,copy,pastetext|bulletlist,orderedlist,indent,outdent|table|code,quote|horizontalrule,image,email,link,unlink|youtube,time|ltr,rtl|print,maximize,source\",\n\t  charset: \"utf-8\",\n\t  style: '/static/css/sceditor/themes/default.min.css',\n\t  emoticonsEnabled: false,\n\t  resizeEnabled: false,\n\t  height:600,\n\t  spellcheck: true,\n\t});\n</script>\n</div>\n<div class=\"form-group\">\n    <label for=\"images\">Файлы</label>\n    <input type=\"file\" class=\"form-control\" id=\"images\" name=\"images[]\"  data-show-upload=\"false\" data-show-caption=\"true\" multiple placeholder=\"\">\n</div>\n\n      </div>\n      <div class=\"modal-footer\">\n<button id=\"news-SUBMIT-BUTTON\" type=\"button\" class=\"btn btn-primary\">\n  <span>Save</span>\n</button>\n<button type=\"button\" class=\"btn btn-secondary\" data-dismiss=\"modal\">Close</button>\n      </div>\n    </div>\n  </div>\n</form>\n</div>\n\n<div class=\"row\">\n\t<div class=\"col-lg-10\">\n    \n\t\t<table\n\t\t  id=\"table-table_edit_news\"\n\t\t  data-toolbar=\"#toolbar-table_edit_news\"\n\t\t  data-toggle=\"table\"\n\n\t\t  data-id-field=\"id\"\n\t\t  data-click-to-select=\"true\"\n\t\t  data-url=\"\"\n\t\t  data-response-handler=\"responseTableHandler\">\n\t\t</table>\n\n\t</div>\n</div>\n\n<script>\n\t\nclass tableEdit {\n  constructor() {\n    this.edit_form = \"news\";\n    this.view_url = \"\\/page\\/1news\\/ru_RU?item=\";\n    this.read_item_url = \"\";\n    this.write_item_url = \"\";\n    this.table = $('#table-table_edit_news');\n  }\n  \n  $this.table.bootstrapTable('destroy').bootstrapTable({\n      locale: \"en_US\", \n      columns: [\n      \n        {\n          field: 'id',\n          title: 'ID',\n          sortable:  false ,\n          align: 'center'\n        },\n      \n        {\n          field: 'title',\n          title: 'Title',\n          sortable:  true ,\n          align: 'left'\n        },\n      \n        {\n          field: 'public_at',\n          title: 'Public At',\n          sortable:  true ,\n          align: 'center'\n        },\n      \n        {\n          field: 'operate',\n          title: 'Действия',\n          align: 'left',\n          clickToSelect: false,\n          events: window.operateEvents,\n          formatter: operateFormatter\n        }]\n    })\n}\n</script>\n\n\n\nBye, Sergey Lunkov!\n\n\n</div>\n    <script src=\"https://code.jquery.com/jquery-3.3.1.slim.min.js\" integrity=\"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo\" crossorigin=\"anonymous\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js\" integrity=\"sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49\" crossorigin=\"anonymous\"></script>\n    <script src=\"https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js\" integrity=\"sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy\" crossorigin=\"anonymous\"></script>\n  </body>\n</html>\n"
  render1, okr = renderPage("en_US", "index", "bootstrap4", true, &data)
  assert.Equal(t, true, okr)
  assert.Equal(t, render1_need, render1)

}

func TestCheckUIRenderMinify(t *testing.T) {
	flag.Set("alsologtostderr", "true")
	flag.Set("log_dir", ".")
	flag.Set("v", "9")
	flag.Parse()

  Init("./etc.test/", false, true)
  render_form1_need := "<div class=\"modal fade\" id=request_test tabindex=-1 role=dialog aria-hidden=true><form method=post enctype=multipart/form-data><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Заявление на выдачу</h5><button type=button class=close data-dismiss=modal aria-label=Close>\n<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><ul class=\"stepper horizontal\" id=horizontal-stepper-request_test></ui></div><div class=modal-footer><span>ERR: templateFile(bootstrap4:request_test): not found button 'submit'</span><span>ERR: templateFile(bootstrap4:request_test): not found button 'close'</span></div></div></div></form></div>"
  // Modal Form for New Record
  render_form1 := RenderForm("ru_RU", "request_test", "bootstrap4", true, nil)

  assert.Equal(t, render_form1_need, render_form1)

}
